{extend name="base" /}
{block name="title" }广告位内容管理{/block}
{block name="body" }
<div class="layui-fluid" >
    <div class="layui-card">
        <div class="layui-card-body"  >
            <form class="layui-form" action="" id="form" >
                <div class="layui-form-item">
                    <div class="layui-input-inline" style="width:auto;">
                        <button type="bottom" class="layui-btn layui-btn-primary" onclick="window.parent.callback()">返回</button>
                    </div>
                    <label class="layui-form-label">标题关键词</label>
                    <div class="layui-input-inline">
                        <input type="text" name="keyword" value="" placeholder="标题关键词" autocomplete="off" class="layui-input">
                    </div>
                    <div class="layui-input-inline" style="width:auto;">
                        <button class="layui-btn" lay-submit lay-filter="formDemo">搜索</button>
                    </div>
                    <div class="layui-input-inline" style="width:auto;">
                        <button type="reset" class="layui-btn layui-btn-primary">重置</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
<div class="layui-fluid">
    <div class="layui-card">
        <div class="layui-card-body">
            <table id="adv_box" lay-filter="adv_list"></table>
        </div>
    </div>
</div>
<!-- 操作模板 -->
<script type="text/html" id="toolbarTpl" >
    <button class="layui-btn layui-btn-sm" lay-event="add" >添加广告</button>
</script>
<!-- 操作模板 -->
<script type="text/html" id="ctrlTpl">
    <button class="layui-btn layui-btn-xs layui-bg-red" lay-event="detail"  >编辑</button>
    <button class="layui-btn layui-btn-xs" lay-event="sequence"  >更改排序</button>
</script>
<script>
    var getAdvListApi = "{:url('adv_list/get_adv_list')}",
        advAdvView = "{:url('adv_list/add',['id'=>$param_info.id])}",
        editAdvView = "{:url('adv_list/edit',['posId'=>$param_info.id,'id'=>'adv_id'])}",
        editSequenceApi = "{:url('adv_list/update_sequence')}",
        pos_id = "{$param_info.id}";
    var table = layui.table;
    //执行渲染
    table.render({
        id:'adv_box',
        elem: '#adv_box',
        height: 'auto', //容器高度
        url: getAdvListApi,
        method:'post',
        where:{
            'pos_id' : pos_id
        },
        page: true,
        toolbar: '#toolbarTpl',
        cols: [[
            {field: 'sequence', title: '排序',width:60,align:'center'},
            {field: 'adv_title', title: '标题', width: 100},
            {field: 'adv_img', title: '广告图(点击查看)',width:160, templet:function (d) { return '<div lay-event="show" ><img src='+d.adv_img+' width="150" title="点击放大查看" onclick="show_img(this)" ></div>' }},
            {field: 'adv_url', title: '链接',width:200},
            {field: 'show_type', title: '状态',width:100,align:'center'},
            {field: 'start_date', title: '开始时间',width:160,align:'center'},
            {field: 'end_date', title: '结束时间',width:160,align:'center'},
            {field: 'pos_id', title: '操作',width:160,templet:'#ctrlTpl'}
        ]]
    });
    var form = layui.form;
    layui.use('form', function(){
        form.on('submit', function(data){
            searchData = data.field;
            //上述方法等价于
            table.reload('adv_box', {
                where: searchData,
                page: {
                    curr: 1 //重新从第 1 页开始
                }
            });
            return false;
        });
        form.render();
    });
    function show_img(obj){
        layer.open({
            title:'放大查看',
            type: 1,
            area:['50%','50%'],
            shadeClose: true,
            content: '<img style="display:block;margin:0 auto;"  src="'+$(obj).attr('src')+'" >'
        });
    }
    //头部按钮事件
    table.on('toolbar(adv_list)', function(obj) {
        var data = obj.data;
        var layEvent = obj.event;
        switch( layEvent ){
            case 'add' :
                layer.open({
                    title:'添加广告',
                    type:2,
                    shadeClose: true,
                    closeBtn:1,
                    area:['95%','95%'],
                    content:advAdvView,
                    success:function (layero,index){
                        //子窗口操作
                        // LayuiOpenView = window[layero.find('iframe')[0]['name']];
                    }
                });
                break;
            case 'btn-expand' :
                treetable.expandAll('#menus_list');
                break;
            case 'btn-fold' :
                treetable.foldAll('#menus_list');
                break;
            default :
                return false;
                break;
        }
        return false;
    });

    table.on('tool(adv_list)', function(obj) {
        var data = obj.data;
        var layEvent = obj.event;
        switch(layEvent) {
            case 'detail' ://详情
                url = editAdvView.replace('adv_id',data.adv_id);
                layer.open({
                    title:'编辑广告',
                    type:2,
                    shadeClose: true,
                    closeBtn:1,
                    area:['100%','100%'],
                    content:url,
                    success:function (layero,index){
                        //子窗口操作
                        // LayuiOpenView = window[layero.find('iframe')[0]['name']];
                    }
                });
                break;
            case 'sequence' ://更改排序
                layer.prompt({
                    formType: 2,
                    value: data.sequence,
                    title: '由大到小排序（0-255）',
                    area: ['100px', '25px'] //自定义文本域宽高
                }, function(value, index, elem){
                    if(checkSort_value(value,255)){
                        $.ajax({
                            url: editSequenceApi,
                            type: 'post',
                            dataType: 'json',
                            data: {
                                'adv_id' : data.adv_id,
                                'sequence' : value,
                            },
                            success:function (res) {
                                layer.msg(res.msg, {
                                    time: 1000
                                }, function(){
                                    if( !res.code ){
                                        table.reload('adv_box');
                                    }
                                });
                            },
                            error:function(e){
                                layer.msg('网络错误', {
                                    skin: 'layui-layer-huise'
                                });
                            }
                        });
                        layer.close(index);
                    }else{
                        layer.msg('请填写正确数值');
                    }
                });

                // layer.confirm("删除将把所属广告一并删除，请问是否确认删除", {
                //     btn: ["确定","取消"] //按钮
                // }, function(){
                //     $.ajax({
                //         url: deletedAPI,
                //         type: 'post',
                //         dataType: 'json',
                //         data:{ pos_id:data.pos_id },
                //         success:function (res) {
                //             layer.msg(res.msg, {
                //                 time: 1000
                //             }, function(){
                //                 if( !res.code ){
                //                     table.reload('adv_box');
                //                 }
                //             });
                //         },
                //         error:function(e){
                //             layer.msg('网络错误', {
                //                 skin: 'layui-layer-huise'
                //             });
                //         }
                //     });
                    return false;
                // });
                break;
            default :
                return false;
                break;
        }
        return false;
    });

    //关闭所有二级窗口
    function callback(){
        table.reload('adv_box');
        layer.closeAll();
    }
</script>
{/block}